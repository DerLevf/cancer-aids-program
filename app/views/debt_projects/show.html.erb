<div class="project-details-container">
  
  <h1><%= @debt_project.name %></h1>

  <div class="card project-summary">
    <p><strong>Gesamtbetrag:</strong> <%= number_to_currency(@debt_project.total_amount || 0, unit: "CHF") %></p>
    <p><strong>Frist:</strong> <%= @debt_project.deadline&.strftime("%d.%m.%Y") || "Keine Frist" %></p>
    <p><strong>Erstellt von:</strong> <%= @debt_project.creator&.username || "Unbekannt" %></p>
  </div>

  <%# CORRECTED: Single action-buttons-group for primary actions %>
  <div class="action-buttons-group"> 
    <% if policy(@debt_project).edit? %>
      <%= link_to "Bearbeiten", edit_debt_project_path(@debt_project), class: "btn btn-warning" %>
    <% end %>

    <% if policy(@debt_project).destroy? %>
      <%= button_to "Löschen", debt_project_path(@debt_project), method: :delete, data: { turbo_confirm: "Willst du diese Gruppe wirklich löschen?" }, class: "btn btn-danger" %>
    <% end %>
    
    <% if policy(@debt_project).show_completed_tasks? %>
      <%= link_to "Abgeschlossene Aufgaben anzeigen", completed_tasks_debt_project_path(@debt_project), class: "btn btn-primary" %>
    <% end %>
  </div>

  <h2>Mitglieder</h2>
  <ul class="member-list card">
    <% @debt_project.group_memberships.includes(:user).each do |membership| %>
      <% next unless membership.user %>
      <%# Corrected class to match CSS: member-schuldner or member-debtcollector %>
      <li class="member member-<%= membership.role.to_s.underscore %>"> 
        <%= membership.user.username %> (<%= membership.role.humanize %>)
      </li>
    <% end %>
  </ul>
  
  <hr class="separator">

<h2>Aufgaben</h2>
<div class="tasks-list">
  <% @debt_project.tasks.each do |task| %>
    <% next if task.status == 'completed' %>

    <div class="card task-item">
      <p><strong>Titel:</strong> <%= task.title %></p>
      <p><strong>Beschreibung:</strong> <%= task.description %></p>
      <p><strong>Zugewiesen an:</strong> <%= task.assigned_user&.username || "Nicht zugewiesen" %></p>
      
      <p>
        <strong>Status:</strong> 
        <% 
          task_status_class = if task.deadline.present? && task.deadline < Date.today && task.status != 'completed'
                                'overdue'
                              else
                                task.status
                              end
        %>
        
        <span class="member status-tag status-<%= task_status_class %>"><%= task_status_class.humanize %></span>
      </p>

      <div class="task-actions">
        <% if policy(task).update? %>
          <%= link_to "Bearbeiten", edit_debt_project_task_path(@debt_project, task), class: "btn btn-warning btn-small" %>
        <% end %>

        <% if policy(task).destroy? %>
          <%= button_to "Löschen", debt_project_task_path(@debt_project, task), method: :delete, data: { turbo_confirm: "Willst du diese Aufgabe wirklich löschen?" }, class: "btn btn-danger btn-small" %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

  <% if policy(Task.new(debt_project: @debt_project)).create? %>
    <%= link_to "Neue Aufgabe", new_debt_project_task_path(@debt_project), class: "btn btn-primary new-task-button" %>
  <% end %>

  <%= link_to "Zurück zur Übersicht", debt_projects_path, class: "back-link" %>
</div>